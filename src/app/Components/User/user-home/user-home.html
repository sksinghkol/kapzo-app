
<!-- Store Section -->
<div class="store-section py-4">
  <div class="container">
    <div class="row justify-content-center g-3">
      <!-- Store Card -->
      <div class="col-12 col-md-6 col-lg-5"
           *ngFor="let store of stores; trackBy: trackByStore">
        <div class="card store-card border-0 shadow-sm animate__animated animate__fadeIn">
          <div class="card-body p-3">
            
            <!-- Row 1: Image | Name -->
            <div class="d-flex align-items-center gap-3">
              <!-- Profile Image -->
              <img [src]="getDriveImageUrl(store.profile_image || 'https://randomuser.me/api/portraits/women/64.jpg')"
                   class="rounded-circle profile-img border border-light"
                   alt="Store Owner {{ store.owner_name }}"
                   (error)="onImageError($event, 'store-' + store.store_id)" />

              <!-- Store Info -->
              <div class="flex-grow-1">
                <h6 class="store-title fw-bold mb-1">
                  üè¨ {{ store.store_name }}
                </h6>
                <small class="text-muted">üë§ {{ store.owner_name }}</small>
              </div>
            </div>

            <!-- Contact + Address -->
            <div class="small text-muted mt-2">
              üìû {{ maskPhone(store.owner_phone) }} <br>
              ‚úâÔ∏è {{ store.owner_email }} <br>
              üìç {{ store.local_area }}, {{ store.city }}
            </div>

            <!-- Description -->
            <div class="mt-2">
              <p class="store-description text-muted mb-1" 
                 [class.collapsed]="expandedStoreId !== store.store_id">
                {{ store.description }}
              </p>
              <button class="btn btn-xs btn-gradient" (click)="toggleStore(store.store_id)">
                {{ expandedStoreId === store.store_id ? 'Less' : 'More' }}
              </button>
            </div>

            <!-- Service Areas -->
            <div class="service-section mt-3">
              <h6 class="fw-semibold text-dark small mb-2">
                <i class="fas fa-truck me-1 text-primary"></i> Service Areas
              </h6>
              <div class="d-flex flex-column gap-2">
                <div class="location-badge d-flex align-items-center justify-content-between p-2 rounded shadow-sm"
                     *ngFor="let loc of getStoreDeliveryLocations(store.store_id); trackBy: trackByLocation"
                     [ngClass]="loc.is_store_pickup ? 'bg-light border border-success' : 'bg-light border border-danger'">
                  <div class="d-flex align-items-center gap-2">
                    <i class="fas fa-map-marker-alt text-primary"></i>
                    <span class="fw-semibold">{{ loc.location_name }}</span>
                  </div>
                  <span class="small fw-medium"
                        [ngClass]="loc.is_store_pickup ? 'text-success' : 'text-danger'">
                    {{ loc.is_store_pickup ? '‚úÖ Pickup Available' : '‚ùå No Pickup' }}
                  </span>
                   <p class="location-desc text-muted small mb-0 mt-1">
        {{ loc.description }}
      </p>
                </div>
              </div>
            </div><!-- /service-section -->

          </div>
        </div>
      </div><!-- /col -->
    </div><!-- /row -->
  </div>
</div>


<!-- Product Section -->
<div class="product-section container py-5">
  <h2 class="section-title mb-5 text-center text-primary fw-bold animate__animated animate__pulse">Our Products</h2>
  <div *ngIf="error" class="alert alert-danger alert-dismissible fade show" role="alert">
    {{ error }}
    <button type="button" class="btn-close" (click)="error = null" aria-label="Close"></button>
  </div>
  <!-- Category Filter -->
  <div class="category-filter mb-4 d-flex align-items-center gap-3">
    <label for="categorySelect" class="form-label fw-semibold text-dark">Filter by Category:</label>
    <select id="categorySelect" class="form-select shadow-sm" [(ngModel)]="selectedCategoryId" (change)="filterProducts()">
      <option [value]="null">All Categories</option>
      <option *ngFor="let category of categories; trackBy: trackByCategory" [value]="category.category_id">
        {{ category.parent_id ? '‚Äî ' : '' }}{{ category.name }}
      </option>
    </select>
  </div>
  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
    <div class="col" *ngFor="let product of filteredProducts; trackBy: trackByProduct; let i = index">
      <div class="card product-card h-100 border-0 shadow-lg animate__animated animate__fadeIn">
        <div class="card-img-top image-wrapper position-relative">
          <p class="category text-muted small mb-2 text-center mt-2">
            <span class="sale-badge badge bg-danger rounded-pill float-start" *ngIf="getLowestPrice(product.product_id).discount_percentage > 0">
              Sale!
            </span>
            <b class="p-2">{{ product.category_id | categoryName:categories }}</b>
            <span class="stock-badge badge bg-success rounded-pill float-end" *ngIf="hasStock(product.product_id)">
              In Stock
            </span>
          </p>
          <img [src]="getDriveImageUrl(getProductImages(product.product_id, selectedVariantId)[currentImageIndex[product.product_id] || 0].image_url)"
               class="img-fluid product-img"
               alt="{{ product.name }}"
               (click)="openImageZoom(getProductImages(product.product_id, selectedVariantId)[currentImageIndex[product.product_id] || 0].image_url)"
               (error)="onImageError($event, 'product-' + product.product_id)" />
          <div class="image-previews d-flex align-items-center gap-2 mt-3 justify-content-center">
            <button class="btn btn-outline-primary btn-sm nav-btn prev-btn" (click)="prevImage(product.product_id)" [disabled]="getProductImages(product.product_id, selectedVariantId).length <= 1">
              <i class="fas fa-chevron-left"></i>
            </button>
            <div class="preview-wrapper" *ngFor="let image of getProductImages(product.product_id, selectedVariantId); let imgIndex = index; trackBy: trackByImage"
                 [class.active]="currentImageIndex[product.product_id] === imgIndex">
              <img [src]="getDriveImageUrl(image.image_url)"
                   class="preview-img"
                   alt="{{ product.name }} Preview"
                   (click)="setImageIndex(product.product_id, imgIndex)"
                   (error)="onImageError($event, 'product-preview-' + product.product_id + '-' + imgIndex)"
                   loading="lazy" />
            </div>
            <button class="btn btn-outline-primary btn-sm nav-btn next-btn" (click)="nextImage(product.product_id)" [disabled]="getProductImages(product.product_id, selectedVariantId).length <= 1">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
        <div class="card-body p-4">
          <h5 class="card-title product-title mb-2 fw-semibold text-center">{{ product.name }}</h5>
          
          <div class="price-area mb-3">
            <p class="new-price mb-1 fw-bold text-primary text-center">‚Çπ{{ getLowestPrice(product.product_id).current_price || 'N/A' }}

                 <del class="float-start">‚Çπ{{ getLowestPrice(product.product_id).mrp_price || 'N/A' }}</del>
              <span class="old-price-discount text-danger ms-2 float-end" *ngIf="getLowestPrice(product.product_id).discount_percentage > 0">
                ({{ getLowestPrice(product.product_id).discount_percentage }}% off)
              </span>
            </p>
            <p class="old-price small mb-1">
              <del>‚Çπ{{ getLowestPrice(product.product_id).mrp_price || 'N/A' }}</del>
              <span class="old-price-discount text-danger ms-2" *ngIf="getLowestPrice(product.product_id).discount_percentage > 0">
                ({{ getLowestPrice(product.product_id).discount_percentage }}% off)
              </span>
            </p>
          </div>
          <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-outline-primary btn-sm" (click)="toggleProductDetails(product.product_id)">
              <i class="fas" [ngClass]="expandedProductId === product.product_id ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
              Details
            </button>
            <div class="quantity">
              <input type="number" class="form-control form-control-sm shadow-sm" [(ngModel)]="cartQuantities[product.product_id]" min="1" max="5" placeholder="Qty" />
            </div>
          </div>
          <div class="collapse" [class.show]="expandedProductId === product.product_id">
            <div class="product-details mb-3">
              <p class="small text-muted">{{ product.description }}</p>
            </div>
            <div class="variants-section mb-3">
              <p class="small fw-bold mb-2">Variants:</p>
              <div *ngIf="getVariantsWithDetails(product.product_id).length > 0; else noVariants">
                <div class="variant-card border p-3 rounded bg-light mb-2" *ngFor="let variant of getVariantsWithDetails(product.product_id); trackBy: trackByVariant">
                  <div class="d-flex align-items-center justify-content-between small">
                    <span>{{ variant.size_name }}</span>
                    <span class="color-swatch"
                          [style.backgroundColor]="variant.hex_code"
                          [class.active]="selectedVariantId === variant.variant_id"
                          (click)="selectVariant(product.product_id, variant.variant_id)"></span>
                    <span>{{ variant.color_name }}</span>
                  </div>
                  <div class="small text-muted">
                    Stock: {{ variant.stock_quantity }} | SKU: {{ variant.sku }}
                  </div>
                </div>
              </div>
              <ng-template #noVariants>
                <p class="small text-muted">No variants available.</p>
              </ng-template>
            </div>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-primary btn-sm flex-grow-1" (click)="addToList(product)">
              <i class="fas fa-heart me-2"></i>Wishlist
            </button>
            <button class="btn btn-primary btn-sm flex-grow-1" (click)="addToCart(product, i)">
              <i class="fas fa-shopping-cart me-2"></i>Add to Cart
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Zoom Modal -->
<div class="modal fade image-zoom-modal" *ngIf="zoomImageUrl" [class.show]="zoomImageUrl" (click)="closeImageZoom()" style="display: block;" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 bg-transparent">
      <img [src]="zoomImageUrl" class="zoomed-img img-fluid rounded shadow-lg" alt="Zoomed product image">
    </div>
  </div>
</div>